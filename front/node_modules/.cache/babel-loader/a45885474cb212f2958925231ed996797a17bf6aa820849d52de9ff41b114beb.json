{"ast":null,"code":"import { is as h, looseObject as u, function as R, string as w, nullish as d, optional as M, unknown as X, number as x, boolean as S, parse as v, pipe as U, any as Z } from \"valibot\";\nimport { AbortablePromise as $ } from \"better-promises\";\nimport { AbortablePromise as Qe, CancelledError as Be, ManualPromise as Ke, TimeoutError as Ye, isCancelledError as Fe, isTimeoutError as He } from \"better-promises\";\nimport { createLogger as O, createCbCollector as V, getStorageValue as ee, setStorageValue as j, deepSnakeToCamelObjKeys as te } from \"@telegram-apps/toolkit\";\nimport { themeParams as re, jsonParse as z, MiniAppsMessageSchema as D, isLaunchParamsQuery as N, parseLaunchParamsQuery as y, serializeLaunchParamsQuery as oe } from \"@telegram-apps/transformers\";\nimport ne from \"mitt\";\nimport { errorClass as b, errorClassWithData as ae } from \"error-kid\";\nimport { signal as G } from \"@telegram-apps/signals\";\nfunction J(e) {\n  return h(u({\n    TelegramWebviewProxy: u({\n      postEvent: R()\n    })\n  }), e);\n}\nfunction Q() {\n  try {\n    return window.self !== window.top;\n  } catch {\n    return !0;\n  }\n}\nfunction se(e, t) {\n  const r = ne(),\n    o = /* @__PURE__ */new Map(),\n    s = (n, a, c) => {\n      c || (c = !1);\n      const i = o.get(n) || /* @__PURE__ */new Map();\n      o.set(n, i);\n      const _ = i.get(a) || [];\n      i.set(a, _);\n      const l = _.findIndex(f => f[1] === c);\n      l >= 0 && (r.off(n, _[l][0]), _.splice(l, 1), !_.length && i.delete(a), i.size || (o.delete(n), !o.size && t()));\n    };\n  return [function (a, c, i) {\n    !o.size && e();\n    function _() {\n      s(a, c, i);\n    }\n    function l(...k) {\n      i && _(), a === \"*\" ? c(k) : c(...k);\n    }\n    r.on(a, l);\n    const f = o.get(a) || /* @__PURE__ */new Map();\n    o.set(a, f);\n    const P = f.get(c) || [];\n    return f.set(c, P), P.push([l, i || !1]), _;\n  }, s,\n  // eslint-disable-next-line @typescript-eslint/unbound-method\n  r.emit, function () {\n    const a = r.all.size;\n    r.all.clear(), o.clear(), a && t();\n  }];\n}\nfunction A(e, t) {\n  window.dispatchEvent(new MessageEvent(\"message\", {\n    data: JSON.stringify({\n      eventType: e,\n      eventData: t\n    }),\n    // We specify window.parent to imitate the case, the parent iframe sent us this event.\n    source: window.parent\n  }));\n}\nlet g = !1;\nconst [E, ce] = O(\"Bridge\", {\n    bgColor: \"#9147ff\",\n    textColor: \"white\",\n    shouldLog() {\n      return g;\n    }\n  }),\n  q = e => {\n    E(!1, \"Event received:\", e);\n  };\nfunction ie(e) {\n  e !== g && (g = e, g ? B(\"*\", q) : _e(\"*\", q));\n}\nconst pe = {\n  clipboard_text_received: u({\n    req_id: w(),\n    data: d(w())\n  }),\n  custom_method_invoked: u({\n    req_id: w(),\n    result: M(X()),\n    error: M(w())\n  }),\n  popup_closed: d(u({\n    button_id: d(w(), () => {})\n  }), {}),\n  viewport_changed: u({\n    height: x(),\n    width: d(x(), () => window.innerWidth),\n    is_state_stable: S(),\n    is_expanded: S()\n  }),\n  theme_changed: u({\n    theme_params: re()\n  })\n};\nfunction L(e) {\n  if (e.source !== window.parent) return;\n  let t;\n  try {\n    t = v(U(w(), z(), D), e.data);\n  } catch {\n    return;\n  }\n  const {\n      eventType: r,\n      eventData: o\n    } = t,\n    s = pe[r];\n  try {\n    const n = s ? v(s, o) : o;\n    ue(r, n);\n  } catch (n) {\n    ce(!0, [`An error occurred processing the \"${r}\" event from the Telegram application.`, \"Please, file an issue here:\", \"https://github.com/Telegram-Mini-Apps/telegram-apps/issues/new/choose\"].join(`\n`), t, n);\n  }\n}\nconst [B, _e, ue, le] = se(() => {\n    const e = window,\n      t = {\n        receiveEvent: A\n      };\n    e.TelegramGameProxy_receiveEvent = A, e.TelegramGameProxy = t, e.Telegram = {\n      WebView: t\n    }, window.addEventListener(\"message\", L);\n  }, () => {\n    [\"TelegramGameProxy_receiveEvent\", \"TelegramGameProxy\", \"Telegram\"].forEach(e => {\n      delete window[e];\n    }), window.removeEventListener(\"message\", L);\n  }),\n  [we, Le] = b(\"MethodUnsupportedError\", (e, t) => [`Method \"${e}\" is unsupported in Mini Apps version ${t}`]),\n  [fe, Te] = b(\"MethodParameterUnsupportedError\", (e, t, r) => [`Parameter \"${t}\" of \"${e}\" method is unsupported in Mini Apps version ${r}`]),\n  [me, Ce] = ae(\"LaunchParamsRetrieveError\", e => ({\n    errors: e\n  }), e => [[\"Unable to retrieve launch parameters from any known source. Perhaps, you have opened your app outside Telegram?\", \"ðŸ“– Refer to docs for more information:\", \"https://docs.telegram-mini-apps.com/packages/telegram-apps-bridge/environment\", \"\", \"Collected errors:\", ...e.map(([t, r]) => `Source: ${t} / ${r instanceof Error ? r.message : String(r)}`)].join(`\n`)]),\n  [be, Ie] = b(\"InvalidLaunchParamsError\", (e, t) => [`Invalid value for launch params: ${e}`, {\n    cause: t\n  }]),\n  [de, We] = b(\"UnknownEnvError\"),\n  [ge, Re] = b(\"InvokeCustomMethodError\", e => [`Server returned error: ${e}`]),\n  m = G((...e) => window.parent.postMessage(...e)),\n  he = (...e) => m()(...e),\n  K = G(\"https://web.telegram.org\");\nfunction Y(e, t) {\n  E(!1, \"Posting event:\", t ? {\n    eventType: e,\n    eventData: t\n  } : {\n    eventType: e\n  });\n  const r = window,\n    o = JSON.stringify({\n      eventType: e,\n      eventData: t\n    });\n  if (Q()) return he(o, K());\n  if (J(r)) {\n    r.TelegramWebviewProxy.postEvent(e, JSON.stringify(t));\n    return;\n  }\n  if (h(u({\n    external: u({\n      notify: R()\n    })\n  }), r)) {\n    r.external.notify(o);\n    return;\n  }\n  throw new de();\n}\nfunction F(e, t, r) {\n  r || (r = {});\n  const {\n      capture: o\n    } = r,\n    [s, n] = V();\n  return new $(a => {\n    (Array.isArray(t) ? t : [t]).forEach(c => {\n      s(B(c, i => {\n        (!o || (Array.isArray(t) ? o({\n          event: c,\n          payload: i\n        }) : o(i))) && a(i);\n      }));\n    }), (r.postEvent || Y)(e, r.params);\n  }, r).finally(n);\n}\nconst T = \"launchParams\";\nfunction C(e) {\n  return e.replace(/^[^?#]*[?#]/, \"\").replace(/[?#]/g, \"&\");\n}\nfunction H() {\n  const e = [];\n  for (const [t, r] of [\n  // Try to retrieve launch parameters from the current location. This method can return\n  // nothing in case, location was changed, and then the page was reloaded.\n  [() => C(window.location.href), \"window.location.href\"],\n  // Then, try using the lower level API - window.performance.\n  [() => {\n    const o = performance.getEntriesByType(\"navigation\")[0];\n    return o && C(o.name);\n  }, \"performance navigation entries\"], [() => ee(T), \"local storage\"]]) {\n    const o = t();\n    if (!o) {\n      e.push([r, new Error(\"Source is empty\")]);\n      continue;\n    }\n    if (N(o)) return j(T, o), o;\n    try {\n      y(o);\n    } catch (s) {\n      e.push([r, s]);\n    }\n  }\n  throw new me(e);\n}\nfunction ve(e) {\n  const t = y(H());\n  return e ? te(t) : t;\n}\nfunction Ue(e, t) {\n  if (!e) try {\n    return ve(), !0;\n  } catch {\n    return !1;\n  }\n  return $.fn(async r => {\n    if (J(window)) return !0;\n    try {\n      return await F(\"web_app_request_theme\", \"theme_changed\", r), !0;\n    } catch {\n      return !1;\n    }\n  }, t || {\n    timeout: 100\n  });\n}\nfunction $e({\n  launchParams: e,\n  onEvent: t,\n  resetPostMessage: r\n} = {}) {\n  if (e) {\n    const n = typeof e == \"string\" || e instanceof URLSearchParams ? e.toString() :\n    // Here we have to trick serializeLaunchParamsQuery into thinking, it serializes a valid\n    // value. We are doing it because we are working with tgWebAppData presented as a\n    // string, not an object as serializeLaunchParamsQuery requires.\n    oe({\n      ...e,\n      tgWebAppData: void 0\n    }) + (e.tgWebAppData ? `&tgWebAppData=${encodeURIComponent(e.tgWebAppData.toString())}` : \"\");\n    if (!N(n)) try {\n      y(n);\n    } catch (a) {\n      throw new be(n, a);\n    }\n    j(\"launchParams\", n);\n  }\n  if (Q()) {\n    if (!t) return;\n    const n = U(w(), z(), D);\n    r && m.reset();\n    const a = m();\n    m.set((...c) => {\n      const [i] = c,\n        _ = () => {\n          a(...c);\n        };\n      if (h(n, i)) {\n        const l = v(n, i);\n        t([l.eventType, l.eventData], _);\n      } else _();\n    });\n    return;\n  }\n  const o = window.TelegramWebviewProxy || {},\n    s = o.postEvent || (() => {});\n  window.TelegramWebviewProxy = {\n    ...o,\n    postEvent(n, a) {\n      const c = () => {\n        s(n, a);\n      };\n      t ? t([n, a ? JSON.parse(a) : void 0], c) : c();\n    }\n  }, E(!1, \"Environment was mocked by the mockTelegramEnv function\");\n}\nfunction je() {\n  return new URLSearchParams(H()).get(\"tgWebAppData\") || void 0;\n}\nfunction ye(e) {\n  return ({\n    req_id: t\n  }) => t === e;\n}\nfunction I(e) {\n  return e.split(\".\").map(Number);\n}\nfunction Ee(e, t) {\n  const r = I(e),\n    o = I(t),\n    s = Math.max(r.length, o.length);\n  for (let n = 0; n < s; n += 1) {\n    const a = r[n] || 0,\n      c = o[n] || 0;\n    if (a !== c) return a > c ? 1 : -1;\n  }\n  return 0;\n}\nfunction p(e, t) {\n  return Ee(e, t) <= 0;\n}\nfunction W(e, t, r) {\n  if (typeof r == \"string\") {\n    if (e === \"web_app_open_link\") {\n      if (t === \"try_instant_view\") return p(\"6.4\", r);\n      if (t === \"try_browser\") return p(\"7.6\", r);\n    }\n    if (e === \"web_app_set_header_color\" && t === \"color\") return p(\"6.9\", r);\n    if (e === \"web_app_close\" && t === \"return_back\") return p(\"7.6\", r);\n    if (e === \"web_app_setup_main_button\" && t === \"has_shine_effect\") return p(\"7.10\", r);\n  }\n  switch (e) {\n    case \"web_app_open_tg_link\":\n    case \"web_app_open_invoice\":\n    case \"web_app_setup_back_button\":\n    case \"web_app_set_background_color\":\n    case \"web_app_set_header_color\":\n    case \"web_app_trigger_haptic_feedback\":\n      return p(\"6.1\", t);\n    case \"web_app_open_popup\":\n      return p(\"6.2\", t);\n    case \"web_app_close_scan_qr_popup\":\n    case \"web_app_open_scan_qr_popup\":\n    case \"web_app_read_text_from_clipboard\":\n      return p(\"6.4\", t);\n    case \"web_app_switch_inline_query\":\n      return p(\"6.7\", t);\n    case \"web_app_invoke_custom_method\":\n    case \"web_app_request_write_access\":\n    case \"web_app_request_phone\":\n      return p(\"6.9\", t);\n    case \"web_app_setup_settings_button\":\n      return p(\"6.10\", t);\n    case \"web_app_biometry_get_info\":\n    case \"web_app_biometry_open_settings\":\n    case \"web_app_biometry_request_access\":\n    case \"web_app_biometry_request_auth\":\n    case \"web_app_biometry_update_token\":\n      return p(\"7.2\", t);\n    case \"web_app_setup_swipe_behavior\":\n      return p(\"7.7\", t);\n    case \"web_app_share_to_story\":\n      return p(\"7.8\", t);\n    case \"web_app_setup_secondary_button\":\n    case \"web_app_set_bottom_bar_color\":\n      return p(\"7.10\", t);\n    case \"web_app_request_safe_area\":\n    case \"web_app_request_content_safe_area\":\n    case \"web_app_request_fullscreen\":\n    case \"web_app_exit_fullscreen\":\n    case \"web_app_set_emoji_status\":\n    case \"web_app_add_to_home_screen\":\n    case \"web_app_check_home_screen\":\n    case \"web_app_request_emoji_status_access\":\n    case \"web_app_check_location\":\n    case \"web_app_open_location_settings\":\n    case \"web_app_request_file_download\":\n    case \"web_app_request_location\":\n    case \"web_app_send_prepared_message\":\n    case \"web_app_start_accelerometer\":\n    case \"web_app_start_device_orientation\":\n    case \"web_app_start_gyroscope\":\n    case \"web_app_stop_accelerometer\":\n    case \"web_app_stop_device_orientation\":\n    case \"web_app_stop_gyroscope\":\n    case \"web_app_toggle_orientation_lock\":\n      return p(\"8.0\", t);\n    default:\n      return [\"iframe_ready\", \"iframe_will_reload\", \"web_app_close\", \"web_app_data_send\", \"web_app_expand\", \"web_app_open_link\", \"web_app_ready\", \"web_app_request_theme\", \"web_app_request_viewport\", \"web_app_setup_main_button\", \"web_app_setup_closing_behavior\"].includes(e);\n  }\n}\nfunction ze(e, t) {\n  t || (t = \"strict\");\n  const r = typeof t == \"function\" ? t : o => {\n    const {\n        method: s,\n        version: n\n      } = o,\n      a = \"param\" in o ? new fe(s, o.param, n) : new we(s, n);\n    if (t === \"strict\") throw a;\n    return console.warn(a.message);\n  };\n  return (o, s) => W(o, e) ? o === \"web_app_set_header_color\" && h(u({\n    color: Z()\n  }), s) && !W(o, \"color\", e) ? r({\n    version: e,\n    method: o,\n    param: \"color\"\n  }) : Y(o, s) : r({\n    version: e,\n    method: o\n  });\n}\nfunction De(e, t, r, o) {\n  return F(\"web_app_invoke_custom_method\", \"custom_method_invoked\", {\n    ...(o || {}),\n    params: {\n      method: e,\n      params: t,\n      req_id: r\n    },\n    capture: ye(r)\n  }).then(({\n    result: s,\n    error: n\n  }) => {\n    if (n) throw new ge(n);\n    return s;\n  });\n}\nfunction Ne() {\n  le(), ie(!1), [m, K].forEach(e => {\n    e.unsubAll(), e.reset();\n  });\n}\nexport { Qe as AbortablePromise, Be as CancelledError, be as InvalidLaunchParamsError, ge as InvokeCustomMethodError, me as LaunchParamsRetrieveError, Ke as ManualPromise, fe as MethodParameterUnsupportedError, we as MethodUnsupportedError, Ye as TimeoutError, de as UnknownEnvError, ye as captureSameReq, Ee as compareVersions, ze as createPostEvent, A as emitEvent, J as hasWebviewProxy, De as invokeCustomMethod, Fe as isCancelledError, Q as isIframe, Ie as isInvalidLaunchParamsError, Re as isInvokeCustomMethodError, Ce as isLaunchParamsRetrieveError, Te as isMethodMethodParameterUnsupportedError, Le as isMethodUnsupportedError, Ue as isTMA, He as isTimeoutError, We as isUnknownEnvError, $e as mockTelegramEnv, _e as off, le as offAll, B as on, Y as postEvent, he as postMessage, m as postMessageImplementation, F as request, Ne as resetPackageState, ve as retrieveLaunchParams, je as retrieveRawInitData, H as retrieveRawLaunchParams, ie as setDebug, W as supports, K as targetOrigin };","map":{"version":3,"names":["J","e","h","u","TelegramWebviewProxy","postEvent","R","Q","window","self","top","se","t","r","ne","o","Map","s","off","n","a","c","i","get","set","_","l","findIndex","f","splice","length","delete","size","k","on","P","push","emit","all","clear","A","dispatchEvent","MessageEvent","data","JSON","stringify","eventType","eventData","source","parent","g","E","ce","O","bgColor","textColor","shouldLog","q","ie","B","_e","pe","clipboard_text_received","req_id","w","d","custom_method_invoked","result","M","X","error","popup_closed","button_id","viewport_changed","height","x","width","innerWidth","is_state_stable","S","is_expanded","theme_changed","theme_params","re","L","v","U","z","D","ue","join","le","receiveEvent","TelegramGameProxy_receiveEvent","TelegramGameProxy","Telegram","WebView","addEventListener","forEach","removeEventListener","we","Le","b","fe","Te","me","Ce","ae","errors","map","Error","message","String","be","Ie","cause","de","We","ge","Re","m","G","postMessage","he","K","Y","external","notify","F","capture","V","$","Array","isArray","event","payload","params","finally","T","C","replace","H","location","href","performance","getEntriesByType","name","ee","N","j","y","ve","te","Ue","fn","timeout","$e","launchParams","onEvent","resetPostMessage","URLSearchParams","toString","oe","tgWebAppData","encodeURIComponent","reset","next","parse","je","ye","I","split","Number","Ee","Math","max","p","W","includes","ze","method","version","param","console","warn","color","Z","De","then","Ne","unsubAll"],"sources":["/home/leabrun/python_/KWORK/dj/front/node_modules/@telegram-apps/bridge/src/env/hasWebviewProxy.ts","/home/leabrun/python_/KWORK/dj/front/node_modules/@telegram-apps/bridge/src/env/isIframe.ts","/home/leabrun/python_/KWORK/dj/front/node_modules/@telegram-apps/bridge/src/events/createEmitter.ts","/home/leabrun/python_/KWORK/dj/front/node_modules/@telegram-apps/bridge/src/events/emitEvent.ts","/home/leabrun/python_/KWORK/dj/front/node_modules/@telegram-apps/bridge/src/debug.ts","/home/leabrun/python_/KWORK/dj/front/node_modules/@telegram-apps/bridge/src/events/emitter.ts","/home/leabrun/python_/KWORK/dj/front/node_modules/@telegram-apps/bridge/src/errors.ts","/home/leabrun/python_/KWORK/dj/front/node_modules/@telegram-apps/bridge/src/methods/postMessage.ts","/home/leabrun/python_/KWORK/dj/front/node_modules/@telegram-apps/bridge/src/methods/targetOrigin.ts","/home/leabrun/python_/KWORK/dj/front/node_modules/@telegram-apps/bridge/src/methods/postEvent.ts","/home/leabrun/python_/KWORK/dj/front/node_modules/@telegram-apps/bridge/src/utils/request.ts","/home/leabrun/python_/KWORK/dj/front/node_modules/@telegram-apps/bridge/src/launch-params/retrieveRawLaunchParams.ts","/home/leabrun/python_/KWORK/dj/front/node_modules/@telegram-apps/bridge/src/launch-params/retrieveLaunchParams.ts","/home/leabrun/python_/KWORK/dj/front/node_modules/@telegram-apps/bridge/src/env/isTMA.ts","/home/leabrun/python_/KWORK/dj/front/node_modules/@telegram-apps/bridge/src/env/mockTelegramEnv.ts","/home/leabrun/python_/KWORK/dj/front/node_modules/@telegram-apps/bridge/src/launch-params/retrieveRawInitData.ts","/home/leabrun/python_/KWORK/dj/front/node_modules/@telegram-apps/bridge/src/methods/captureSameReq.ts","/home/leabrun/python_/KWORK/dj/front/node_modules/@telegram-apps/bridge/src/utils/compareVersions.ts","/home/leabrun/python_/KWORK/dj/front/node_modules/@telegram-apps/bridge/src/methods/supports.ts","/home/leabrun/python_/KWORK/dj/front/node_modules/@telegram-apps/bridge/src/methods/createPostEvent.ts","/home/leabrun/python_/KWORK/dj/front/node_modules/@telegram-apps/bridge/src/utils/invokeCustomMethod.ts","/home/leabrun/python_/KWORK/dj/front/node_modules/@telegram-apps/bridge/src/resetPackageState.ts"],"sourcesContent":["import { looseObject, function as fn, is } from 'valibot';\n\n/**\n * Returns true in case, passed value contains path `TelegramWebviewProxy.postEvent` property and\n * `postEvent` is a function.\n * @param value - value to check.\n */\nexport function hasWebviewProxy<T>(value: T): value is T & {\n  TelegramWebviewProxy: {\n    postEvent: (...args: unknown[]) => unknown;\n  };\n} {\n  return is(\n    looseObject({ TelegramWebviewProxy: looseObject({ postEvent: fn() }) }),\n    value,\n  );\n}\n","/**\n * @see https://stackoverflow.com/a/326076\n * @returns True, if current environment is iframe.\n */\nexport function isIframe(): boolean {\n  try {\n    return window.self !== window.top;\n  } catch {\n    return true;\n  }\n}\n","import mitt, {\n  type Emitter,\n  type EventHandlerMap,\n  type EventType,\n  type Handler,\n} from 'mitt';\nimport type { If, IsNever, IsUndefined, Or } from '@telegram-apps/toolkit';\n\nexport type WildcardHandler<E> = Handler<{\n  [K in keyof E]: [K, If<Or<IsNever<E[K]>, IsUndefined<E[K]>>, void, E[K]>]\n}[keyof E]>;\n\nexport interface OnFn<E> {\n  /**\n   * Adds a new listener for the specified event.\n   * @param type - event name.\n   * @param handler - event listener.\n   * @param once - should listener be called only once.\n   * @returns Function to remove bound event listener.\n   */<K extends keyof E>(type: K, handler: Handler<E[K]>, once?: boolean): VoidFunction;\n  /**\n   * Adds a listener for all events.\n   * @param type - event name.\n   * @param handler - event listener.\n   * @param once - should listener be called only once.\n   * @returns Function to remove bound event listener.\n   */\n  (type: '*', handler: WildcardHandler<E>, once?: boolean): VoidFunction;\n}\n\nexport interface OffFn<E> {\n  /**\n   * Removes a listener for the specified event.\n   * @param type - event to listen.\n   * @param handler - event listener to remove.\n   * @param once - had this listener to be called only once.\n   */<K extends keyof E>(type: K, handler: Handler<E[K]>, once?: boolean): void;\n  /**\n   * Removes a listener for all events.\n   * @param type - event to stop listening.\n   * @param handler - event listener to remove.\n   * @param once - had this listener to be called only once.\n   */\n  (type: '*', handler: WildcardHandler<E>, once?: boolean): void;\n}\n\nexport interface EmitFn<E> {\n  <K extends keyof E>(type: K, event: E[K]): void;\n  <K extends keyof E>(type: undefined extends E[K] ? K : never): void;\n}\n\n/**\n * Creates a new enhanced event emitter.\n * @param onFirst - will be called when the first event was added.\n * @param onEmpty - will be called when emitter's listeners' map was emptied.\n */\nexport function createEmitter<E extends object>(\n  onFirst: VoidFunction,\n  onEmpty: VoidFunction,\n): [\n  on: OnFn<E>,\n  off: OffFn<E>,\n  emit: EmitFn<E>,\n  clear: VoidFunction\n] {\n  type EventMap = Map<\n    (...args: any) => void,\n    [handler: (...args: any) => void, once: boolean][]\n  >;\n\n  const emitter = (mitt as any as {\n    <E extends Record<EventType, unknown>>(all?: EventHandlerMap<E>): Emitter<E>;\n  })<E & Record<string | symbol, unknown>>();\n  const map = new Map<keyof E | '*', EventMap>();\n\n  const off: OffFn<E> = (event: keyof E | '*', handler: (...args: any) => void, once?: boolean) => {\n    once ||= false;\n\n    const eventMap: EventMap = map.get(event) || new Map();\n    map.set(event, eventMap);\n\n    const handlers = eventMap.get(handler) || [];\n    eventMap.set(handler, handlers);\n\n    const index = handlers.findIndex(item => item[1] === once);\n    if (index >= 0) {\n      // Remove the related handler.\n      emitter.off(event, handlers[index][0]);\n\n      // Remove the handler from the cache array.\n      handlers.splice(index, 1);\n\n      // If after removal, there are no handlers left, we should remove the entry from the cache.\n      !handlers.length && eventMap.delete(handler);\n      if (!eventMap.size) {\n        map.delete(event);\n        !map.size && onEmpty();\n      }\n    }\n  };\n\n  return [\n    function on(event: keyof E | '*', handler: (...args: any[]) => any, once?: boolean) {\n      !map.size && onFirst();\n\n      function cleanup() {\n        off(event as any, handler, once);\n      }\n\n      function fn(...args: any[]) {\n        once && cleanup();\n        if (event === '*') {\n          handler(args);\n        } else {\n          handler(...args);\n        }\n      }\n\n      emitter.on(event, fn);\n\n      // Add this handler to the cache, so we could remove it using the passed listener.\n      const eventMap = map.get(event) || new Map();\n      map.set(event, eventMap);\n\n      const handlers = eventMap.get(handler) || [];\n      eventMap.set(handler, handlers);\n      handlers.push([fn, once || false]);\n\n      return cleanup;\n    },\n    off,\n    // eslint-disable-next-line @typescript-eslint/unbound-method\n    emitter.emit,\n    function offAll() {\n      const prevSize = emitter.all.size;\n      emitter.all.clear();\n      map.clear();\n      prevSize && onEmpty();\n    },\n  ];\n}\n","import type { EventWithoutPayload, EventWithPayload, EventPayload } from '@/events/types/index.js';\n\n/**\n * Emits an event without payload sent from the Telegram native application like it was sent in\n * a default web environment between two iframes.\n *\n * It dispatches a new MessageEvent and expects it to be handled via\n * the `window.addEventListener('message', ...)` call, as a developer would do it to handle\n * messages sent from the parent iframe.\n * @param eventType - event name.\n */\nexport function emitEvent<E extends EventWithoutPayload>(eventType: E): void;\n\n/**\n * Emits an event with payload sent from the Telegram native application like it was sent in\n * a default web environment between two iframes.\n *\n * It dispatches a new MessageEvent and expects it to be handled via\n * the `window.addEventListener('message', ...)` call, as a developer would do it to handle\n * messages sent from the parent iframe.\n * @param eventType - event name.\n * @param eventData - event payload.\n */\nexport function emitEvent<E extends EventWithPayload>(\n  eventType: E,\n  eventData: EventPayload<E>,\n): void;\n\n/**\n * Emits an unknown event sent from the Telegram native application like it was sent in a default\n * web environment between two iframes.\n *\n * It dispatches a new MessageEvent and expects it to be handled via\n * the `window.addEventListener('message', ...)` call, as a developer would do it to handle\n * messages sent from the parent iframe.\n * @param eventType - event name.\n * @param eventData - event payload.\n */\nexport function emitEvent<E extends string>(\n  eventType: E,\n  eventData: E extends EventWithoutPayload\n    ? never\n    : E extends EventWithPayload\n      ? EventPayload<E>\n      : unknown,\n): void;\n\n/**\n * Emits an event sent from the Telegram native application like it was sent in a default web\n * environment between two iframes.\n *\n * It dispatches a new MessageEvent and expects it to be handled via\n * the `window.addEventListener('message', ...)` call, as a developer would do it to handle\n * messages sent from the parent iframe.\n * @param eventType - event name.\n * @param eventData - event payload.\n */\nexport function emitEvent(eventType: string, eventData?: unknown): void {\n  window.dispatchEvent(new MessageEvent('message', {\n    data: JSON.stringify({ eventType, eventData }),\n    // We specify window.parent to imitate the case, the parent iframe sent us this event.\n    source: window.parent,\n  }));\n}\n","import { createLogger } from '@telegram-apps/toolkit';\n\nimport type { SubscribeListener } from '@/events/types/index.js';\nimport { off, on } from '@/events/emitter.js';\n\n/**\n * The package debug mode.\n *\n * Enabling debug mode leads to printing additional messages in the console related to the\n * processes inside the package.\n */\nlet debug = false;\n\nexport const [logInfo, logError] = createLogger('Bridge', {\n  bgColor: '#9147ff',\n  textColor: 'white',\n  shouldLog() {\n    return debug;\n  },\n});\n\nconst listener: SubscribeListener = event => {\n  logInfo(false, 'Event received:', event);\n};\n\n/**\n * Sets the package debug mode leading to outputting additional logs.\n * @param value - enable debug mode.\n */\nexport function setDebug(value: boolean): void {\n  if (value !== debug) {\n    debug = value;\n    debug ? on('*', listener) : off('*', listener);\n  }\n}\n","import {\n  type InferOutput,\n  parse,\n  pipe,\n  string,\n  looseObject,\n  optional,\n  unknown,\n  number,\n  boolean,\n  nullish,\n  type BaseSchema,\n} from 'valibot';\nimport { jsonParse, MiniAppsMessageSchema, themeParams } from '@telegram-apps/transformers';\n\nimport { createEmitter } from '@/events/createEmitter.js';\nimport type { EventName, EventPayload, Events } from '@/events/types/index.js';\nimport { emitEvent } from '@/events/emitEvent.js';\nimport { logError } from '@/debug.js';\n\n/**\n * Transformers for problematic Mini Apps events.\n */\nconst transformers = {\n  clipboard_text_received: looseObject({\n    req_id: string(),\n    data: nullish(string()),\n  }),\n  custom_method_invoked: looseObject({\n    req_id: string(),\n    result: optional(unknown()),\n    error: optional(string()),\n  }),\n  popup_closed: nullish(\n    looseObject({ button_id: nullish(string(), () => undefined) }),\n    {},\n  ),\n  viewport_changed: looseObject({\n    height: number(),\n    width: nullish(number(), () => window.innerWidth),\n    is_state_stable: boolean(),\n    is_expanded: boolean(),\n  }),\n  theme_changed: looseObject({\n    theme_params: themeParams(),\n  }),\n} as const satisfies { [E in EventName]?: BaseSchema<unknown, EventPayload<E>, any> };\n\nfunction listener(event: MessageEvent): void {\n  // Ignore non-parent window messages.\n  if (event.source !== window.parent) {\n    return;\n  }\n\n  // Parse incoming event data.\n  let message: InferOutput<typeof MiniAppsMessageSchema>;\n  try {\n    message = parse(pipe(string(), jsonParse(), MiniAppsMessageSchema), event.data);\n  } catch {\n    // We ignore incorrect messages as they could be generated by any other code.\n    return;\n  }\n\n  const { eventType, eventData } = message;\n  const schema = transformers[eventType as keyof typeof transformers];\n\n  try {\n    const data = schema ? parse(schema, eventData) : eventData;\n    emit(eventType as any, data);\n  } catch (cause) {\n    logError(\n      true,\n      [\n        `An error occurred processing the \"${eventType}\" event from the Telegram application.`,\n        'Please, file an issue here:',\n        'https://github.com/Telegram-Mini-Apps/telegram-apps/issues/new/choose',\n      ].join('\\n'),\n      message,\n      cause,\n    );\n  }\n}\n\nexport const [\n  on,\n  off,\n  emit,\n  offAll,\n] = createEmitter<Events>(\n  () => {\n    const w = window as any;\n\n    // Define all functions responsible for receiving an event from the Telegram client.\n    // All these \"ports\" should narrow the communication way to a single specific one - the way\n    // accepted by the web version of Telegram between iframes.\n    const obj = { receiveEvent: emitEvent };\n    w.TelegramGameProxy_receiveEvent = emitEvent;\n    w.TelegramGameProxy = obj;\n    w.Telegram = { WebView: obj };\n\n    // Add a listener handling events sent from the Telegram web application and also events\n    // generated by the local emitEvent function.\n    // This handler should emit a new event using the library event emitter.\n    window.addEventListener('message', listener);\n  },\n  () => {\n    ['TelegramGameProxy_receiveEvent', 'TelegramGameProxy', 'Telegram'].forEach((prop) => {\n      delete (window as any)[prop];\n    });\n    window.removeEventListener('message', listener);\n  },\n);\n","import { errorClass, errorClassWithData } from 'error-kid';\nimport type { Version } from '@telegram-apps/types';\n\nexport const [\n  MethodUnsupportedError,\n  isMethodUnsupportedError,\n] = errorClass<[method: string, version: Version]>(\n  'MethodUnsupportedError',\n  (method, version) => [\n    `Method \"${method}\" is unsupported in Mini Apps version ${version}`,\n  ],\n);\n\nexport const [\n  MethodParameterUnsupportedError,\n  isMethodMethodParameterUnsupportedError,\n] = errorClass<[method: string, param: string, version: Version]>(\n  'MethodParameterUnsupportedError',\n  (method, param, version) => [\n    `Parameter \"${param}\" of \"${method}\" method is unsupported in Mini Apps version ${version}`,\n  ],\n);\n\nexport const [\n  LaunchParamsRetrieveError,\n  isLaunchParamsRetrieveError,\n] = errorClassWithData<\n  { errors: [source: string, error: unknown][] },\n  [[source: string, error: unknown][]]\n>(\n  'LaunchParamsRetrieveError',\n  errors => ({ errors }),\n  errors => [\n    [\n      'Unable to retrieve launch parameters from any known source. Perhaps, you have opened your app outside Telegram?',\n      'ðŸ“– Refer to docs for more information:',\n      'https://docs.telegram-mini-apps.com/packages/telegram-apps-bridge/environment',\n      '',\n      'Collected errors:',\n      ...errors.map(([source, error]) => {\n        return `Source: ${source} / ${error instanceof Error ? error.message : String(error)}`;\n      }),\n    ].join('\\n'),\n  ],\n);\n\nexport const [\n  InvalidLaunchParamsError,\n  isInvalidLaunchParamsError,\n] = errorClass<[launchParams: string, cause: unknown]>(\n  'InvalidLaunchParamsError',\n  (launchParams, cause) => [\n    `Invalid value for launch params: ${launchParams}`,\n    { cause },\n  ],\n);\n\nexport const [UnknownEnvError, isUnknownEnvError] = errorClass('UnknownEnvError');\n\nexport const [\n  InvokeCustomMethodError,\n  isInvokeCustomMethodError,\n] = errorClass<[error: string]>(\n  'InvokeCustomMethodError',\n  error => [`Server returned error: ${error}`],\n);","import { signal } from '@telegram-apps/signals';\n\nexport type PostMessage = typeof window.parent.postMessage;\n\n/**\n * Signal containing a custom implementation of the method to post a message to the parent\n * window. We usually use it to send a message in web versions of Telegram.\n *\n * Initially, this value contains a function behaving like the `window.parent.postMessage` method.\n */\nexport const postMessageImplementation = signal<PostMessage>((...args: any[]) => {\n  return window.parent.postMessage(...args as Parameters<PostMessage>);\n});\n\n/**\n * Posts a message to the parent window. We usually use it to send a message in web versions of Telegram.\n * @param args - `window.parent.postMessage` arguments.\n */\nexport const postMessage: PostMessage = (...args) => {\n  return postMessageImplementation()(...args as unknown as Parameters<PostMessage>);\n};\n","import { signal } from '@telegram-apps/signals';\n\n/**\n * Target origin used by the `postEvent` method.\n *\n * You don't need to override this value until you know what you are doing.\n * @default 'https://web.telegram.org'\n */\nexport const targetOrigin = signal('https://web.telegram.org');\n","import { is, looseObject, function as fn } from 'valibot';\n\nimport { logInfo } from '@/debug.js';\nimport { isIframe } from '@/env/isIframe.js';\nimport { hasWebviewProxy } from '@/env/hasWebviewProxy.js';\nimport { UnknownEnvError } from '@/errors.js';\nimport type {\n  MethodName,\n  MethodNameWithOptionalParams,\n  MethodNameWithoutParams,\n  MethodNameWithRequiredParams,\n  MethodParams,\n} from '@/methods/types/index.js';\n\nimport { postMessage } from './postMessage.js';\nimport { targetOrigin } from './targetOrigin.js';\n\nexport type PostEventFn = typeof postEvent;\n\n/**\n * Calls Mini Apps methods requiring parameters.\n * @param method - method name.\n * @param params - options along with params.\n * @throws {UnknownEnvError} The environment is unknown.\n */\nexport function postEvent<Method extends MethodNameWithRequiredParams>(\n  method: Method,\n  params: MethodParams<Method>,\n): void;\n\n/**\n * Calls Mini Apps methods accepting no parameters at all.\n * @param method - method name.\n * @throws {UnknownEnvError} The environment is unknown.\n */\nexport function postEvent(method: MethodNameWithoutParams): void;\n\n/**\n * Calls Mini Apps methods accepting optional parameters.\n * @param method - method name.\n * @param params - options along with params.\n * @throws {UnknownEnvError} The environment is unknown.\n */\nexport function postEvent<Method extends MethodNameWithOptionalParams>(\n  method: Method,\n  params?: MethodParams<Method>,\n): void;\n\nexport function postEvent(\n  eventType: MethodName,\n  eventData?: MethodParams<MethodName>,\n): void {\n  logInfo(false, 'Posting event:', eventData ? { eventType, eventData } : { eventType });\n\n  const w = window;\n\n  const message = JSON.stringify({ eventType, eventData });\n\n  // Telegram Web.\n  if (isIframe()) {\n    return postMessage(message, targetOrigin());\n  }\n\n  // Telegram for iOS, macOS, Android and Telegram Desktop.\n  if (hasWebviewProxy(w)) {\n    w.TelegramWebviewProxy.postEvent(eventType, JSON.stringify(eventData));\n    return;\n  }\n\n  // Telegram for Windows Phone or Android.\n  if (is(looseObject({ external: looseObject({ notify: fn() }) }), w)) {\n    w.external.notify(message);\n    return;\n  }\n\n  // Otherwise, the current environment is unknown, and we are not able to send event.\n  throw new UnknownEnvError();\n}\n","import {\n  createCbCollector,\n  type If,\n  type IsNever,\n} from '@telegram-apps/toolkit';\nimport { AbortablePromise, type PromiseOptions } from 'better-promises';\n\nimport { on } from '@/events/emitter.js';\nimport { postEvent, PostEventFn } from '@/methods/postEvent.js';\nimport type {\n  MethodName,\n  MethodNameWithOptionalParams,\n  MethodNameWithoutParams,\n  MethodNameWithRequiredParams,\n  MethodParams,\n} from '@/methods/types/index.js';\nimport type { EventName, EventPayload } from '@/events/types/events.js';\n\ntype AnyEventName = EventName | EventName[];\n\nexport type RequestCaptureFnEventsPayload<E extends EventName[]> = E extends (infer U extends EventName)[]\n  ? {\n    [K in U]: If<\n      IsNever<EventPayload<K>>,\n      { event: K },\n      { event: K; payload: EventPayload<K> }\n    >\n  }[U]\n  : never;\n\nexport type RequestCaptureEventsFn<E extends EventName[]> = (\n  payload: RequestCaptureFnEventsPayload<E>,\n) => boolean\n\nexport type RequestCaptureEventFn<E extends EventName> = If<\n  IsNever<EventPayload<E>>,\n  () => boolean,\n  (payload: EventPayload<E>) => boolean\n>;\n\nexport type RequestCaptureFn<E extends AnyEventName> = E extends EventName[]\n  ? RequestCaptureEventsFn<E>\n  : E extends EventName\n    ? RequestCaptureEventFn<E>\n    : never;\n\nexport interface RequestOptions<E extends AnyEventName>\n  extends Omit<PromiseOptions, 'rejectOnAbort'> {\n  /**\n   * Should return true if this event should be captured.\n   * The first compatible request will be captured if this property is omitted.\n   */\n  capture?: RequestCaptureFn<E>;\n  /**\n   * Custom function to call mini apps methods.\n   */\n  postEvent?: PostEventFn;\n}\n\nexport type RequestResult<E extends AnyEventName> =\n  E extends (infer U extends EventName)[]\n    ? U extends infer K extends EventName\n      ? If<IsNever<EventPayload<K>>, undefined, EventPayload<K>>\n      : never\n    : E extends EventName\n      ? If<IsNever<EventPayload<E>>, undefined, EventPayload<E>>\n      : never;\n\nexport type RequestFn = typeof request;\n\n/**\n * Performs a request waiting for specified events to occur.\n *\n * This overriding is used for methods, requiring parameters.\n * @param method - method name.\n * @param eventOrEvents - tracked event or events.\n * @param options - additional options.\n */\nexport function request<M extends MethodNameWithRequiredParams, E extends AnyEventName>(\n  method: M,\n  eventOrEvents: E,\n  options: RequestOptions<E> & { params: MethodParams<M> },\n): AbortablePromise<RequestResult<E>>;\n\n/**\n * Performs a request waiting for specified events to occur.\n *\n * This overriding is used for methods with optional parameters.\n * @param method - method name.\n * @param eventOrEvents - tracked event or events.\n * @param options - additional options.\n */\nexport function request<M extends MethodNameWithOptionalParams, E extends AnyEventName>(\n  method: M,\n  eventOrEvents: E,\n  options?: RequestOptions<E> & { params?: MethodParams<M> },\n): AbortablePromise<RequestResult<E>>;\n\n/**\n * Performs a request waiting for specified events to occur.\n *\n * This overriding is used for methods without parameters.\n * @param method - method name.\n * @param eventOrEvents - tracked event or events.\n * @param options - additional options.\n */\nexport function request<M extends MethodNameWithoutParams, E extends AnyEventName>(\n  method: M,\n  eventOrEvents: E,\n  options?: RequestOptions<E>,\n): AbortablePromise<RequestResult<E>>;\n\nexport function request<M extends MethodName, E extends AnyEventName>(\n  method: M,\n  eventOrEvents: E,\n  options?: RequestOptions<E> & { params?: MethodParams<M> },\n): AbortablePromise<RequestResult<E>> {\n  options ||= {};\n  const { capture } = options;\n  const [addCleanup, cleanup] = createCbCollector();\n\n  return new AbortablePromise<RequestResult<E>>((resolve) => {\n    // We need to iterate over all tracked events and create their event listeners.\n    ((Array.isArray(eventOrEvents) ? eventOrEvents : [eventOrEvents])).forEach(event => {\n      // Each event listener waits for the event to occur.\n      // Then, if the capture function was passed, we should check if the event should be captured.\n      // If the function is omitted, we instantly capture the event.\n      addCleanup(\n        on(event, payload => {\n          if (!capture || (\n            Array.isArray(eventOrEvents)\n              ? (capture as RequestCaptureEventsFn<EventName[]>)({\n                event,\n                payload,\n              } as RequestCaptureFnEventsPayload<EventName[]>)\n              : (capture as RequestCaptureEventFn<EventName>)(payload)\n          )) {\n            resolve(payload as RequestResult<E>);\n          }\n        }),\n      );\n    });\n\n    (options.postEvent || postEvent)(method as any, (options as any).params);\n  }, options)\n    .finally(cleanup);\n}\n","import { isLaunchParamsQuery, parseLaunchParamsQuery } from '@telegram-apps/transformers';\nimport { getStorageValue, setStorageValue } from '@telegram-apps/toolkit';\n\nimport { LaunchParamsRetrieveError } from '@/errors.js';\n\nconst SESSION_STORAGE_KEY = 'launchParams';\n\n/**\n * @param urlString - URL to extract launch parameters from.\n * @returns Launch parameters from the specified URL.\n * @throws Error if function was unable to extract launch parameters from the passed URL.\n */\nfunction fromURL(urlString: string): string {\n  return urlString\n    // Replace everything before this first hashtag or question sign.\n    .replace(/^[^?#]*[?#]/, '')\n    // Replace all hashtags and question signs to make it look like some search params.\n    .replace(/[?#]/g, '&');\n}\n\n/**\n * @returns Launch parameters in a raw format from any known source.\n * @throws {LaunchParamsRetrieveError} Unable to retrieve launch parameters. They are probably\n * invalid.\n */\nexport function retrieveRawLaunchParams(): string {\n  const errors: [source: string, error: unknown][] = [];\n  for (const [retrieve, source] of [\n    // Try to retrieve launch parameters from the current location. This method can return\n    // nothing in case, location was changed, and then the page was reloaded.\n    [() => fromURL(window.location.href), 'window.location.href'],\n    // Then, try using the lower level API - window.performance.\n    [() => {\n      const navigationEntry = performance.getEntriesByType('navigation')[0] as PerformanceNavigationTiming | undefined;\n      return navigationEntry && fromURL(navigationEntry.name);\n    }, 'performance navigation entries'],\n    [() => getStorageValue<string>(SESSION_STORAGE_KEY), 'local storage'],\n  ] as const) {\n    const v = retrieve();\n    if (!v) {\n      errors.push([source, new Error('Source is empty')]);\n      continue;\n    }\n    if (isLaunchParamsQuery(v)) {\n      setStorageValue(SESSION_STORAGE_KEY, v);\n      return v;\n    }\n    try {\n      parseLaunchParamsQuery(v);\n    } catch (e) {\n      errors.push([source, e]);\n    }\n  }\n  throw new LaunchParamsRetrieveError(errors);\n}","import { LaunchParamsSchema, parseLaunchParamsQuery } from '@telegram-apps/transformers';\nimport {\n  type DeepConvertSnakeKeysToCamelCase,\n  deepSnakeToCamelObjKeys,\n} from '@telegram-apps/toolkit';\nimport type { InferOutput } from 'valibot';\n\nimport { retrieveRawLaunchParams } from '@/launch-params/retrieveRawLaunchParams.js';\n\nexport type RetrieveLPResult = InferOutput<typeof LaunchParamsSchema>;\nexport type RetrieveLPResultCamelCased =\n  DeepConvertSnakeKeysToCamelCase<InferOutput<typeof LaunchParamsSchema>>;\n\n/**\n * @returns Launch parameters from any known source.\n * @param camelCase - should the output be camel-cased.\n * @throws {LaunchParamsRetrieveError} Unable to retrieve launch parameters. They are probably\n * invalid.\n */\nexport function retrieveLaunchParams(camelCase?: false): RetrieveLPResult;\n\n/**\n * @returns Launch parameters from any known source.\n * @param camelCase - should the output be camel-cased.\n * @throws {LaunchParamsRetrieveError} Unable to retrieve launch parameters. They are probably\n * invalid.\n */\nexport function retrieveLaunchParams(camelCase: true): RetrieveLPResultCamelCased;\n\n/**\n * @returns Launch parameters from any known source.\n * @throws {LaunchParamsRetrieveError} Unable to retrieve launch parameters. They are probably\n * invalid.\n */\nexport function retrieveLaunchParams(camelCase?: boolean):\n  | RetrieveLPResult\n  | RetrieveLPResultCamelCased {\n  const launchParams = parseLaunchParamsQuery(retrieveRawLaunchParams());\n  return camelCase ? deepSnakeToCamelObjKeys(launchParams) : launchParams;\n}\n","import { AbortablePromise, type PromiseOptions } from 'better-promises';\n\nimport { request } from '@/utils/request.js';\nimport { hasWebviewProxy } from '@/env/hasWebviewProxy.js';\nimport { retrieveLaunchParams } from '@/launch-params/retrieveLaunchParams.js';\n\n/**\n * Returns true if the current environment is Telegram Mini Apps.\n *\n * It uses the `retrieveLaunchParams` function to determine if the environment contains\n * launch parameters. In case it does, true will be returned.\n *\n * In case you need stricter checks, use async override of this function.\n */\nexport function isTMA(): boolean;\n\n/**\n * Returns promise with true if the current environment is Telegram Mini Apps.\n *\n * First of all, it checks if the current environment contains traits specific to the\n * Mini Apps environment.\n * Then, it attempts to call a Mini Apps method and waits for a response to be received.\n *\n * In case you need less strict checks, use sync override of this function.\n */\nexport function isTMA(type: 'complete', options?: PromiseOptions): AbortablePromise<boolean>\n\nexport function isTMA(\n  type?: 'complete',\n  options?: PromiseOptions,\n): boolean | AbortablePromise<boolean> {\n  if (!type) {\n    try {\n      retrieveLaunchParams();\n      return true;\n    } catch {\n      return false;\n    }\n  }\n\n  return AbortablePromise.fn(async context => {\n    if (hasWebviewProxy(window)) {\n      return true;\n    }\n    try {\n      await request('web_app_request_theme', 'theme_changed', context);\n      return true;\n    } catch {\n      return false;\n    }\n  }, options || { timeout: 100 });\n}\n","import { is, parse, pipe, string } from 'valibot';\nimport {\n  isLaunchParamsQuery,\n  jsonParse,\n  type LaunchParamsLike,\n  MiniAppsMessageSchema,\n  serializeLaunchParamsQuery,\n  parseLaunchParamsQuery,\n} from '@telegram-apps/transformers';\nimport { If, IsNever, setStorageValue } from '@telegram-apps/toolkit';\n\nimport { logInfo } from '@/debug.js';\nimport { isIframe } from '@/env/isIframe.js';\nimport type { MethodName, MethodParams } from '@/methods/types/index.js';\nimport { InvalidLaunchParamsError } from '@/errors.js';\nimport { postMessageImplementation } from '@/methods/postMessage.js';\n\n/**\n * Mocks the environment and imitates Telegram Mini Apps behavior.\n *\n * We usually use this function in the following cases:\n * 1. We are developing an application outside the Telegram environment and would like to imitate\n * the Telegram client in order to re-create the same communication behavior.\n * 2. We would like to intercept some Telegram Mini Apps methods' calls in order to enhance them\n * or write a custom behavior. It is extremely useful in some Telegram clients improperly handling\n * Mini Apps methods' calls and not even responding.\n *\n * Note that calling this function in Telegram web clients, the `postMessageImplementation` signal\n * value will be updated with a new one, enhancing previously set signal value to allow wrapping\n * the original `window.parent.postMessage` function. In other words, calling `mockTelegramEnv`\n * function N times, you will effectively wrap previously set implementation N times, so be\n * careful calling this function several times during a single lifecycle of the app. In case you\n * would like to avoid such kind of behavior, use the `resetPostMessage` option.\n */\nexport function mockTelegramEnv({ launchParams, onEvent, resetPostMessage }: {\n  /**\n   * Launch parameters to mock. They will be saved in the storage, so the SDK functions could\n   * retrieve them.\n   *\n   * Note that this value must have `tgWebAppData` presented in a raw format as long as you will\n   * need it when retrieving init data in this format. Otherwise, init data may be broken.\n   */\n  launchParams?:\n    | (Omit<LaunchParamsLike, 'tgWebAppData'> & { tgWebAppData?: string | URLSearchParams })\n    | string\n    | URLSearchParams;\n  /**\n   * Function that will be called if a Mini Apps method call was requested by the mini app.\n   *\n   * It receives a Mini Apps method name along with the passed payload.\n   *\n   * Note that using the `next` function, in non-web environments it uses the\n   * `window.TelegramWebviewProxy.postEvent`.\n   *\n   * Talking about the web versions of Telegram, the value is a bit more complex - it will\n   * equal to the value stored in the `postMessageImplementation` signal set previously. By default,\n   * this value contains a function utilizing the `window.parent.postMessage` method.\n   * @param event - event information.\n   * @param next - function to call the original method used to call a Mini Apps method.\n   */\n  onEvent?: (\n    event: {\n      [M in MethodName]: [M, If<IsNever<MethodParams<M>>, void, MethodParams<M>>]\n    }[MethodName] | [string, unknown],\n    next: () => void,\n  ) => void;\n  /**\n   * Removes all previously set enhancements of the `window.parent.postMessage` function set\n   * by other `mockTelegramEnv` calls.\n   * @default false\n   */\n  resetPostMessage?: boolean;\n} = {}): void {\n  if (launchParams) {\n    // If launch parameters were passed, save them in the session storage, so\n    // the retrieveLaunchParams function would return them.\n    const launchParamsQuery =\n      typeof launchParams === 'string' || launchParams instanceof URLSearchParams\n        ? launchParams.toString()\n        : (\n          // Here we have to trick serializeLaunchParamsQuery into thinking, it serializes a valid\n          // value. We are doing it because we are working with tgWebAppData presented as a\n          // string, not an object as serializeLaunchParamsQuery requires.\n          serializeLaunchParamsQuery({ ...launchParams, tgWebAppData: undefined })\n          // Then, we just append init data.\n          + (launchParams.tgWebAppData ? `&tgWebAppData=${encodeURIComponent(launchParams.tgWebAppData.toString())}` : '')\n        );\n\n    // Remember to check if launch params are valid.\n    if (!isLaunchParamsQuery(launchParamsQuery)) {\n      try {\n        parseLaunchParamsQuery(launchParamsQuery);\n      } catch (e) {\n        throw new InvalidLaunchParamsError(launchParamsQuery, e);\n      }\n    }\n    setStorageValue('launchParams', launchParamsQuery);\n  }\n\n  // Original postEvent firstly checks if the current environment is iframe.\n  // That's why we have a separate branch for this environment here too.\n  if (isIframe()) {\n    if (!onEvent) {\n      return;\n    }\n    const MiniAppsMessageJson = pipe(\n      string(),\n      jsonParse(),\n      MiniAppsMessageSchema,\n    );\n\n    // As long as the postEvent function uses the postMessage method, we should rewire it.\n    resetPostMessage && postMessageImplementation.reset();\n    const original = postMessageImplementation();\n    postMessageImplementation.set((...args) => {\n      const [message] = args;\n      const next = () => {\n        (original as any)(...args);\n      };\n\n      // Pass only Telegram Mini Apps events to the handler. All other calls should be passed\n      // to the original handler (window.parent.postMessage likely).\n      if (is(MiniAppsMessageJson, message)) {\n        const data = parse(MiniAppsMessageJson, message);\n        onEvent([data.eventType, data.eventData], next);\n      } else {\n        next();\n      }\n    });\n\n    return;\n  }\n\n  // In all other environments, it is enough to define window.TelegramWebviewProxy.postEvent.\n  const proxy = (window as any).TelegramWebviewProxy || {};\n  const postEventDefaulted = proxy.postEvent || (() => undefined);\n  (window as any).TelegramWebviewProxy = {\n    ...proxy,\n    postEvent(eventType: string, eventData: string) {\n      const next = () => {\n        postEventDefaulted(eventType, eventData);\n      };\n      onEvent\n        ? onEvent([eventType, eventData ? JSON.parse(eventData) : undefined], next)\n        : next();\n    },\n  };\n\n  logInfo(false, 'Environment was mocked by the mockTelegramEnv function');\n}\n","import { retrieveRawLaunchParams } from '@/launch-params/retrieveRawLaunchParams.js';\n\n/**\n * @returns Raw init data from any known source.\n * @throws {LaunchParamsRetrieveError} Unable to retrieve launch params from any known source.\n */\nexport function retrieveRawInitData(): string | undefined {\n  return new URLSearchParams(retrieveRawLaunchParams()).get('tgWebAppData') || undefined;\n}","type CaptureSameReqFn = (payload: { req_id: string }) => boolean;\n\n/**\n * Returns a function which can be used in `request` function `capture` property to capture\n * the event with the same request identifier.\n * @param reqId - request identifier.\n */\nexport function captureSameReq(reqId: string): CaptureSameReqFn {\n  return ({ req_id }) => req_id === reqId;\n}\n","import type { Version } from '@telegram-apps/types';\n\nfunction parts(a: Version): number[] {\n  return a.split('.').map(Number);\n}\n\n/**\n * @param a - first version.\n * @param b - second version.\n * @returns\n * - `1` if the version \"a\" is greater than \"b\".\n * - `0` the version \"a\" is equal to \"b\".\n * - `-1` the version \"a\" is lower than \"b\".\n */\nexport function compareVersions(a: Version, b: Version): number {\n  const aParts = parts(a);\n  const bParts = parts(b);\n  const len = Math.max(aParts.length, bParts.length);\n\n  // Iterate over each part of versions and compare them. In case, part is\n  // missing, assume its value is equal to 0.\n  for (let i = 0; i < len; i += 1) {\n    const aVal = aParts[i] || 0\n    const bVal = bParts[i] || 0;\n\n    if (aVal === bVal) {\n      continue;\n    }\n    return aVal > bVal ? 1 : -1;\n  }\n  return 0;\n}\n","import type { Version } from '@telegram-apps/types';\n\nimport { compareVersions } from '@/utils/compareVersions.js';\nimport type {\n  MethodName,\n  MethodNameWithVersionedParams,\n  MethodVersionedParams,\n} from '@/methods/types/index.js';\n\n/**\n * Returns true if \"a\" version is less than or equal to \"b\" version.\n * @param a\n * @param b\n */\nfunction versionLessOrEqual(a: Version, b: Version): boolean {\n  return compareVersions(a, b) <= 0;\n}\n\n/**\n * Returns true in case, passed parameter in specified method is supported.\n * @param method - method name\n * @param param - method parameter\n * @param inVersion - platform version.\n */\nexport function supports<M extends MethodNameWithVersionedParams>(\n  method: M,\n  param: MethodVersionedParams<M>,\n  inVersion: Version,\n): boolean;\n\n/**\n * Returns true in case, specified method is supported in a passed version.\n * @param method - method name.\n * @param inVersion - platform version.\n */\nexport function supports(method: MethodName, inVersion: Version): boolean;\n\nexport function supports(\n  method: MethodName,\n  paramOrVersion: Version | string,\n  inVersion?: string,\n): boolean {\n  // Method name, parameter, target version.\n  if (typeof inVersion === 'string') {\n    if (method === 'web_app_open_link') {\n      if (paramOrVersion === 'try_instant_view') {\n        return versionLessOrEqual('6.4', inVersion);\n      }\n      if (paramOrVersion === 'try_browser') {\n        return versionLessOrEqual('7.6', inVersion);\n      }\n    }\n\n    if (method === 'web_app_set_header_color') {\n      if (paramOrVersion === 'color') {\n        return versionLessOrEqual('6.9', inVersion);\n      }\n    }\n\n    if (method === 'web_app_close' && paramOrVersion === 'return_back') {\n      return versionLessOrEqual('7.6', inVersion);\n    }\n\n    if (method === 'web_app_setup_main_button' && paramOrVersion === 'has_shine_effect') {\n      return versionLessOrEqual('7.10', inVersion);\n    }\n  }\n\n  switch (method) {\n    case 'web_app_open_tg_link':\n    case 'web_app_open_invoice':\n    case 'web_app_setup_back_button':\n    case 'web_app_set_background_color':\n    case 'web_app_set_header_color':\n    case 'web_app_trigger_haptic_feedback':\n      return versionLessOrEqual('6.1', paramOrVersion);\n    case 'web_app_open_popup':\n      return versionLessOrEqual('6.2', paramOrVersion);\n    case 'web_app_close_scan_qr_popup':\n    case 'web_app_open_scan_qr_popup':\n    case 'web_app_read_text_from_clipboard':\n      return versionLessOrEqual('6.4', paramOrVersion);\n    case 'web_app_switch_inline_query':\n      return versionLessOrEqual('6.7', paramOrVersion);\n    case 'web_app_invoke_custom_method':\n    case 'web_app_request_write_access':\n    case 'web_app_request_phone':\n      return versionLessOrEqual('6.9', paramOrVersion);\n    case 'web_app_setup_settings_button':\n      return versionLessOrEqual('6.10', paramOrVersion);\n    case 'web_app_biometry_get_info':\n    case 'web_app_biometry_open_settings':\n    case 'web_app_biometry_request_access':\n    case 'web_app_biometry_request_auth':\n    case 'web_app_biometry_update_token':\n      return versionLessOrEqual('7.2', paramOrVersion);\n    case 'web_app_setup_swipe_behavior':\n      return versionLessOrEqual('7.7', paramOrVersion);\n    case 'web_app_share_to_story':\n      return versionLessOrEqual('7.8', paramOrVersion);\n    case 'web_app_setup_secondary_button':\n    case 'web_app_set_bottom_bar_color':\n      return versionLessOrEqual('7.10', paramOrVersion);\n    case 'web_app_request_safe_area':\n    case 'web_app_request_content_safe_area':\n    case 'web_app_request_fullscreen':\n    case 'web_app_exit_fullscreen':\n    case 'web_app_set_emoji_status':\n    case 'web_app_add_to_home_screen':\n    case 'web_app_check_home_screen':\n    case 'web_app_request_emoji_status_access':\n    case 'web_app_check_location':\n    case 'web_app_open_location_settings':\n    case 'web_app_request_file_download':\n    case 'web_app_request_location':\n    case 'web_app_send_prepared_message':\n    case 'web_app_start_accelerometer':\n    case 'web_app_start_device_orientation':\n    case 'web_app_start_gyroscope':\n    case 'web_app_stop_accelerometer':\n    case 'web_app_stop_device_orientation':\n    case 'web_app_stop_gyroscope':\n    case 'web_app_toggle_orientation_lock':\n      return versionLessOrEqual('8.0', paramOrVersion);\n    default:\n      return [\n        'iframe_ready',\n        'iframe_will_reload',\n        'web_app_close',\n        'web_app_data_send',\n        'web_app_expand',\n        'web_app_open_link',\n        'web_app_ready',\n        'web_app_request_theme',\n        'web_app_request_viewport',\n        'web_app_setup_main_button',\n        'web_app_setup_closing_behavior',\n      ].includes(method);\n  }\n}\n","import { any, is, looseObject } from 'valibot';\nimport type { Version } from '@telegram-apps/types';\n\nimport { supports } from '@/methods/supports.js';\nimport { type PostEventFn, postEvent } from '@/methods/postEvent.js';\nimport type {\n  MethodName,\n  MethodNameWithVersionedParams,\n  MethodVersionedParams,\n} from '@/methods/types/index.js';\nimport { MethodParameterUnsupportedError, MethodUnsupportedError } from '@/errors.js';\n\nexport type OnUnsupportedFn = (\n  data: { version: Version } & (\n    | { method: MethodName }\n    | {\n    [M in MethodNameWithVersionedParams]: {\n      method: M;\n      param: MethodVersionedParams<M>;\n    };\n  }[MethodNameWithVersionedParams]),\n) => void;\n\nexport type CreatePostEventMode = 'strict' | 'non-strict';\n\n/**\n * Creates a function that checks if the specified method and parameters are supported.\n *\n * If the method or parameters are unsupported, the `onUnsupported` function will be called.\n *\n * If `strict` or `non-strict` value was passed as the second argument, the function\n * will create its own `onUnsupported` function with behavior depending on the value passed.\n *\n * - Passing `strict` will make the function to throw a `MethodParameterUnsupportedError`\n * or a `MethodUnsupportedError` error.\n * - Passing `non-strict` will just warn you about something being unsupported.\n *\n * @param version - Telegram Mini Apps version.\n * @param onUnsupportedOrMode - function or strict mode. Default: `strict`\n */\nexport function createPostEvent(\n  version: Version,\n  onUnsupportedOrMode?: OnUnsupportedFn | CreatePostEventMode,\n): PostEventFn {\n  onUnsupportedOrMode ||= 'strict';\n  const onUnsupported: OnUnsupportedFn = typeof onUnsupportedOrMode === 'function'\n    ? onUnsupportedOrMode\n    : data => {\n      const { method, version } = data;\n      const error = 'param' in data\n        ? new MethodParameterUnsupportedError(method, data.param, version)\n        : new MethodUnsupportedError(method, version);\n\n      if (onUnsupportedOrMode === 'strict') {\n        throw error;\n      }\n      return console.warn(error.message);\n    };\n\n  return ((method: any, params: any) => {\n    // Firstly, check if the method is supported.\n    if (!supports(method, version)) {\n      return onUnsupported({ version, method });\n    }\n\n    // Method could use parameters, which are supported only in specific versions of Mini Apps.\n    // We are validating only those parameters, which are not backward compatible.\n    if (\n      method === 'web_app_set_header_color'\n      && is(looseObject({ color: any() }), params)\n      && !supports(method, 'color', version)\n    ) {\n      return onUnsupported({ version, method, param: 'color' });\n    }\n\n    return postEvent(method, params);\n  }) as PostEventFn;\n}\n","import { AbortablePromise } from 'better-promises';\n\nimport { captureSameReq } from '@/methods/captureSameReq.js';\nimport type { CustomMethodName, CustomMethodParams } from '@/methods/types/index.js';\nimport { InvokeCustomMethodError } from '@/errors.js';\n\nimport { request, type RequestOptions } from './request.js';\n\nexport type InvokeCustomMethodOptions = Omit<RequestOptions<'custom_method_invoked'>, 'capture'>;\nexport type InvokeCustomMethodFn = typeof invokeCustomMethod;\n\n/**\n * Invokes known custom method. Returns method execution result.\n * @param method - method name.\n * @param params - method parameters.\n * @param requestId - request identifier.\n * @param options - additional options.\n * @throws {InvokeCustomMethodError} Invocation completed with some error.\n */\nexport function invokeCustomMethod<M extends CustomMethodName>(\n  method: M,\n  params: CustomMethodParams<M>,\n  requestId: string,\n  options?: InvokeCustomMethodOptions,\n): AbortablePromise<unknown>;\n\n/**\n * Invokes unknown custom method. Returns method execution result.\n * @param method - method name.\n * @param params - method parameters.\n * @param requestId - request identifier.\n * @param options - additional options.\n * @throws {InvokeCustomMethodError} Invocation completed with some error.\n */\nexport function invokeCustomMethod(\n  method: string,\n  params: object,\n  requestId: string,\n  options?: InvokeCustomMethodOptions,\n): AbortablePromise<unknown>;\n\nexport function invokeCustomMethod(\n  method: string,\n  params: object,\n  requestId: string,\n  options?: InvokeCustomMethodOptions,\n): AbortablePromise<unknown> {\n  return request('web_app_invoke_custom_method', 'custom_method_invoked', {\n    ...options || {},\n    params: { method, params, req_id: requestId },\n    capture: captureSameReq(requestId),\n  })\n    .then(({ result, error }) => {\n      if (error) {\n        throw new InvokeCustomMethodError(error);\n      }\n      return result;\n    });\n}\n","import { targetOrigin } from '@/methods/targetOrigin.js';\nimport { setDebug } from '@/debug.js';\nimport { offAll } from '@/events/emitter.js';\nimport { postMessageImplementation } from '@/methods/postMessage.js';\n\n/**\n * Resets the package state. Normally, you don't use this function in your application.\n * We are using it only for test purposes.\n */\nexport function resetPackageState() {\n  offAll();\n  setDebug(false);\n  [postMessageImplementation, targetOrigin].forEach(s => {\n    s.unsubAll();\n    s.reset();\n  });\n}"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}